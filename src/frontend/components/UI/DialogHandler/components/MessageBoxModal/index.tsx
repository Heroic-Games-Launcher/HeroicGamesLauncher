import './index.css'
import React, { ReactElement, useMemo } from 'react'
import {
  Dialog,
  DialogContent,
  DialogFooter,
  DialogHeader
} from 'frontend/components/UI/Dialog'
import classNames from 'classnames'
import { useTranslation } from 'react-i18next'
import { DialogType, ButtonOptions } from 'common/types'
import { DialogCheckbox } from 'frontend/types'
import ToggleSwitch from 'frontend/components/UI/ToggleSwitch'
interface MessageBoxModalProps {
  title: string
  message: string | ReactElement
  onClose: () => void
  buttons: Array<ButtonOptions>
  type: DialogType
  checkboxes?: Array<DialogCheckbox>
}

// This function proper parses the message from the backend and returns HTML code with an array of spans and paragraphs
function decodeHTML(html: string): Array<JSX.Element> {
  const txt = document.createElement('textarea')
  txt.innerHTML = html
  return txt.value.split('\n').map((item, key) => {
    return (
      <span key={key}>
        {item}
        <p />
      </span>
    )
  })
}

const MessageBoxModal: React.FC<MessageBoxModalProps> = function (props) {
  const { t } = useTranslation()

  const message = useMemo(() => {
    if (typeof props.message === 'string') return decodeHTML(props.message)
    else return props.message
  }, [props.message])

  const getButtons = function () {
    const allButtons = []
    for (let i = 0; i < props.buttons.length; ++i) {
      allButtons.push(
        <button
          onClick={() => {
            props.onClose()
            props.buttons[i].onClick?.()
          }}
          className={`button is-secondary outline`}
          key={'messageBoxModalButton_' + i.toString()}
        >
          {props.buttons[i].text}
        </button>
      )
    }
    return allButtons
  }

  const getContent = () => {
    switch (props.type) {
      case 'ERROR':
        return (
          <>
            <div className="errorDialog contentHeader">
              {t('error', 'Error')}:
            </div>
            <div className="errorDialog error-box">{message}</div>
          </>
        )
        break
      default:
        return (
          <>
            {message}
            {props.checkboxes && props.checkboxes.length > 0 && (
              <div className="checkboxes-wrapper">
                {props.checkboxes.map((checkbox) => (
                  <ToggleSwitch
                    key={checkbox.id}
                    htmlId={checkbox.id}
                    title={checkbox.label}
                    value={checkbox.value}
                    handleChange={() => checkbox.onChange(!checkbox.value)}
                    disabled={checkbox.disabled}
                    description={checkbox.description}
                  />
                ))}
              </div>
            )}
          </>
        )
    }
  }

  return (
    <Dialog
      onClose={props.onClose}
      showCloseButton
      className={classNames({ errorDialog: props.type === 'ERROR' })}
    >
      <DialogHeader onClose={props.onClose}>{props.title}</DialogHeader>
      <DialogContent>{getContent()}</DialogContent>
      <DialogFooter>{getButtons()}</DialogFooter>
    </Dialog>
  )
}

export default MessageBoxModal
