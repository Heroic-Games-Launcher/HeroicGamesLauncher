name: Lint

on:
  pull_request:
    branches: [main, stable]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/install-deps
      - name: Lint code.
        run: pnpm lint
      - name: Prettier code.
        run: pnpm prettier
      - name: Find dead code
        run: pnpm find-deadcode
      - name: ESLint JSON (for SARIF)
        run: |
          pnpm exec eslint . \
            --ext .js,.jsx,.ts,.tsx \
            --format json \
            --output-file eslint-results.json \
            --no-error-on-unmatched-pattern || true
          if [ ! -s eslint-results.json ]; then echo '{}' > eslint-results.json; fi
      - name: Convert ESLint JSON to SARIF
        run: pnpm dlx @microsoft/eslint-formatter-sarif@3.1.0 -o eslint-results.sarif eslint-results.json
      - name: Upload ESLint SARIF to code scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: eslint-results.sarif
